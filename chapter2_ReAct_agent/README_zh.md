# 第二章：ReAct 智能体架构

[English Version](./README.md)

## 第二章新增功能

基于第一章的工具调用基础，第二章引入了完整的 **ReAct（推理与行动）智能体系统**：

- **递归对话处理**，实现连续的 AI 交互
- **工具执行框架**，包含安全控制机制  
- **用户批准系统**，针对危险操作的安全防护
- **单例对话管理器**，统一状态管理

## ReAct 架构

![ReAct Architecture](./images/ReAct_architect.png)

ReAct 模式通过以下循环实现智能体：

1. **思考**：AI 接收输入并进行推理
2. **行动**：基于推理结果调用工具
3. **观察**：获取工具执行反馈
4. **迭代**：将观察结果输入下一轮推理

## 对话流程架构

![Conversation Sequence](./images/conversation.png)

对话流程图展示了驱动 ReAct 智能体系统的复杂消息处理机制。这个架构通过精心编排的交互序列，实现了人类用户、AI 推理和工具执行之间的无缝集成。

### 详细流程分析

**阶段一：用户发起**
- 用户通过界面提交消息
- [`Conversation`](src/core/conversation.py) 单例接收并验证输入
- 消息添加到对话历史中以保持上下文

**阶段二：AI 处理与决策**
- 用户消息通过 [`APIClient`](src/core/api_client.py) 发送给 AI 模型
- AI 执行推理并判断是否需要工具调用
- 如需工具：AI 生成结构化工具调用请求
- 如不需要：AI 直接向用户提供响应

**阶段三：工具调用检测与执行**
- [`ToolManager`](src/tools/tool_manager.py) 检测 AI 响应中的工具调用
- 系统检查工具是否需要用户批准（安全机制）
- 如获批准：通过相应的 [`BaseAgent`](src/tools/base_agent.py) 实现执行工具
- 捕获工具结果并格式化供 AI 使用

**阶段四：结果整合与迭代**
- 工具结果作为 "tool" 角色消息添加到对话上下文
- 增强的上下文发送回 AI 进行结果解释
- AI 处理工具输出并提供最终面向用户的响应
- **递归继续**：如果 AI 判断需要更多工具，循环重复

**阶段五：响应交付**
- 最终 AI 响应呈现给用户
- 更新并保存对话状态以供下次交互
- 系统准备就绪接受后续用户输入

### 关键实现特性

- **单例模式**：确保跨交互的一致对话状态
- **递归消息处理**：支持复杂的多步骤工具链
- **安全控制**：对潜在危险操作的用户批准门控
- **上下文保持**：维护完整对话历史以实现连贯交互
- **错误恢复**：每个阶段的强大异常处理

这个架构为后续章节中引入的所有高级功能奠定了基础。


## 核心组件

### 对话管理器
[`Conversation`](src/core/conversation.py) - 控制 ReAct 循环：

```python
def recursive_message_handling(self, user_message):
    """实现连续的思考-行动-观察循环"""
    # 发送消息给 AI → 检查工具调用 → 执行 → 重复
```

**关键特性**：
- 多轮交互的递归消息处理
- AI 响应中的自动工具调用检测
- 危险操作需要用户批准的安全控制
- 完整的错误处理和恢复机制

### 工具管理系统
[`ToolManager`](src/tools/tool_manager.py) - 处理工具生命周期：

- **注册**：集中的工具清单管理
- **模式生成**：为 AI 提供 JSON Schema
- **执行代理**：将工具调用路由到具体实现

### 工具实现
所有工具继承自 [`BaseAgent`](src/tools/base_agent.py)：

- **CmdRunner**：系统命令执行，包含超时和批准控制

## 交互流程示例

```
用户: "列出当前目录下的文件"
     ↓
AI: "我将使用 ls 命令列出文件"
     ↓
系统: [检测工具调用] → [请求批准] → [执行命令]
     ↓
AI: "这些是文件：[结果]"
```

## 架构优势

- **安全性**：用户批准防止危险操作
- **可扩展性**：通过继承轻松添加新工具
- **可靠性**：全面的错误处理和状态管理
- **透明性**：清晰的推理链可见性

## 下一步

→ **第三章**：添加实时流式输出，提升 AI 交互过程中的用户体验。
