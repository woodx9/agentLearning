# 第五章：智能上下文裁剪

[English Version](./README.md)

## 第五章新增功能

第五章在第四章自动历史压缩基础上，增加了**智能上下文裁剪** - 用于高级对话管理的精确工具：

### 🎯 智能上下文裁剪工具
- **精确控制**：从顶部或底部裁剪指定数量的消息
- **安全保证**：始终保护最新用户消息和系统消息
- **摘要支持**：为裁剪内容提供可选摘要以保持上下文连续性
- **即时生效**：裁剪操作立即生效，优化性能
- **无缝集成**：与现有工具链和批准系统完美配合

## 上下文裁剪 vs 自动压缩

| 功能 | 自动压缩（第四章） | 智能裁剪（第五章） |
|------|------------------|------------------|
| **触发方式** | 自动（阈值触发） | 手动（用户/AI 决策） |
| **控制方式** | 系统驱动 | 用户/AI 驱动 |
| **精确度** | 会话级别 | 消息级别 |
| **使用场景** | 性能管理 | 策略性上下文控制 |

## 裁剪策略

### 顶部裁剪
移除最旧的消息，保留系统上下文：
```python
# 裁剪前：[系统] [旧-1] [旧-2] [近期-1] [近期-2] [最新用户]
# 从顶部裁剪 2 条消息
# 裁剪后：[系统] [近期-1] [近期-2] [最新用户]
```

### 底部裁剪
移除近期消息（除最新用户消息外）：
```python
# 裁剪前：[系统] [旧-1] [旧-2] [近期-1] [近期-2] [最新用户]
# 从底部裁剪 2 条消息
# 裁剪后：[系统] [旧-1] [旧-2] [最新用户]
```

## 智能上下文裁剪工具

### 工具定义
```python
{
    "name": "smart_context_cropper",
    "description": "带安全保证的对话历史裁剪",
    "parameters": {
        "need_user_approve": "是否需要用户批准",
        "crop_direction": "方向：'top' 或 'bottom'",
        "crop_amount": "要移除的消息数量",
        "deleted_messages_summary": "移除内容的摘要"
    }
}
```

### 使用示例

**场景一**：清理调试日志
```
AI：经过几次尝试我找到了问题。让我清理一下调试历史。
<smart_context_cropper>
  need_user_approve: false
  crop_direction: bottom
  crop_amount: 5
  deleted_messages_summary: "移除了 5 次带错误日志的调试尝试。问题通过修复数据库连接字符串得到解决。"
</smart_context_cropper>
```

**场景二**：专注当前任务
```
用户：我们裁剪掉之前功能的讨论，专注于当前的实现。
AI：我将裁剪之前的讨论以专注于您当前的任务。
<smart_context_cropper>
  need_user_approve: true
  crop_direction: top
  crop_amount: 8
  deleted_messages_summary: "移除了关于功能 A 和 B 的讨论。当前重点：实现带身份验证的功能 C。"
</smart_context_cropper>
```

## 技术实现

### 智能上下文裁剪工具
[`SmartContextCropper`](src/tools/smart_context_cropper.py)：

```python
def execute(self, need_user_approve, crop_direction, crop_amount, deleted_messages_summary):
    """执行带安全检查的智能上下文裁剪"""
    
    # 验证参数
    # 应用安全保护
    # 执行裁剪操作
    # 更新对话状态
```

### 安全机制
- **用户消息保护**：最新用户消息永不移除
- **系统消息保护**：系统提示始终保留
- **批准流程**：危险操作需要确认
- **验证机制**：参数验证防止无效操作

## 与现有功能的集成

### 与第四章功能配合
- **自动压缩**：智能裁剪与自动压缩并行工作
- **成本跟踪**：裁剪的消息仍计入成本计算
- **历史管理**：与现有历史管理系统集成

### 增强的用户体验
```
🎯 智能裁剪：从顶部移除了 3 条消息
📝 摘要：清理了初始设置讨论。焦点：部署配置
💬 上下文：2,100/8,192 令牌 (26%) 💰 会话：$0.018
```

## 使用场景

- **长时间调试会话**：移除已解决的问题以专注于当前问题
- **话题转换**：切换到无关话题时清理上下文
- **性能优化**：策略性移除以实现更快处理
- **上下文聚焦**：保留相关信息同时移除干扰

## 优势

- **精确性**：完全控制移除的内容
- **安全性**：内置保护防止意外数据丢失
- **灵活性**：适用于自动和手动上下文管理
- **性能**：无需重新开始对话即可立即优化

## 下一步

→ **第六章**：添加 TodoWrite 工具实现复杂工作流程的结构化任务管理。
